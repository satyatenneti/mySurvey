<apex:page showHeader="true" sidebar="false" standardStylesheets="false" controller="SendSurveyController">
    <c:ScriptIncludes />
    <apex:includescript value="//code.jquery.com/jquery-1.11.1.min.js" / >
    <apex:includescript value="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" />
    <apex:stylesheet value="//cdn.datatables.net/1.10.4/css/jquery.dataTables.css" />
    <style>
        * { margin: 0; padding: 0;}
        textarea { resize: none;}
        body .bodyDiv #bodyTable { padding-right: 0; padding-left: 0; background-color: #eee; }
        .form-container {width: 60%; padding: 20px; margin: 20px auto; background-color: #fff; box-shadow: 0px 0px 8px #888888; border-radius: 5px;}
        .section { padding: 15px; margin: 5px 0px; background-color: #fff; box-shadow: 0px 0px 8px #888888;}
        .table { width: 80%; margin: 0 auto; }
        input, label { font-weight: normal; font: normal 16px Arial; color: #575757;  }
        input.control-button { padding: 10px; border-radius: 5px; background-color: #4d90fe; color: #fff; font-weight: bold; min-width: 90px; cursor: pointer;}
        input.control-button:hover { background-color:#357ae8; }
        .test {
            padding: 10px;  margin: 25px 5px 0px 5px; width: 100%; 
        }
        
        .font-large { font-size: 2em; }
        .bold-text{  font-weight: bold; }
        .margin-10px { margin: 10px; }
        .small-text { font-size: 0.95em;}
        .error  { color: red;}
    </style>
    
    <apex:form id="sendSurvey">
        <div class="form-container">
            <div><apex:pageMessages /></div>
            <div class="font-large bold-text margin-10px">{!survey.Name}</div>
            <hr />
            <table class="table">
                <tr><th colspan="2" style="float: right;">
                    <select id="send-form-to-select" class="test">
                            <option value="">Send form to</option> 
                            <option value="users">Users</option> 
                            <option value="contacts">Contacts</option> 
                            <option value="groups">Groups</option> 
                            <option value="others">Others</option> 
                    </select></th>
                </tr>
               <tr>
                    <td><div id="users" class="section" style="display: none;">


                        <table id="usertable" class="display">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Image</th>
                                </tr>
                            </thead>
                            <tbody>
                                <apex:repeat value="{!userDetailsList}" var="userDetail">
                                    <tr>
                                        <td><input type="checkbox" data-id="{!userDetail.user.Id}" value="{!userDetail.selected}"  /></td> 
                                        <td>{!userDetail.user.FirstName}</td>
                                        <td>{!userDetail.user.LastName}</td>
                                        <td><apex:image url="{!userDetail.user.smallphotourl}" /></td>
                                    </tr>
                                </apex:repeat>
                            </tbody>
                        </table>
                        <apex:outputPanel rendered="{!userDetailsList.size == 0}">No Users exist.</apex:outputPanel>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="contacts" class="section" style="display: none;">

                            <table id="contacttable" class="display">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <apex:repeat value="{!contactDetailsList}" var="contactDetail">
                                        <tr>
                                            <td><input type="checkbox" data-id="{!contactDetail.contact.Id}" value="{!contactDetail.selected}"  /></td> 
                                            <td>{!contactDetail.contact.FirstName}</td>
                                            <td>{!contactDetail.contact.LastName}</td>
                                        </tr>
                                    </apex:repeat>
                                </tbody>
                            </table>
                            <apex:outputPanel rendered="{!contactDetailsList.size == 0}">No Contacts exist.</apex:outputPanel>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="groups" class="section" style="display: none;">
                            <apex:outputPanel rendered="{! groupsList.size != 0}">
                                    <label class="bold-text">Select Groups</label>
                                    <apex:selectList styleClass="sender-list ui-selectmenu-button ui-widget ui-state-default ui-corner-top" style="overflow:auto" id="select-groups" size="5" value="{!selectedGroups}" multiselect="true">
                                        <apex:selectOptions value="{!groupsList}"/>
                                    </apex:selectList>
                            </apex:outputPanel>
                            <apex:outputPanel rendered="{!groupsList.size == 0}">No Groups exist.</apex:outputPanel>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="others" class="section" style="display: none;">
                            <apex:outputPanel>
                                <label class="bold-text">External Emails</label><br/ >
                                <label class="small-text">Please select list of comma seperated email ids.</label>
                                <br />
                                <apex:inputTextarea id="external-emails" value="{!externalContacts}" rows="5"  cols="100" /> 
                            </apex:outputPanel><br/>
                            <span id="email-error" class="error" style="display: none;">Invalid Email Ids</span>
                        </div>
                    </td>
                </tr>
                <tr><td>
                        <apex:outputPanel >
                            <input type="button" style="display: none;" class="control-button" value="Send Form" onclick="doValidateAndSendForm()" />
                        </apex:outputPanel>
                    </td>
                </tr>
            </table>
        </div>
        <apex:inputHidden value="{!sendTo}" id="sendTo"/>
        <apex:inputHidden value="{!selectedIds}" id="selectedIds"/>
        <apex:actionFunction action="{!sendForm}" name="sendSurveyForm" />
    </apex:form>
    <script type="text/javascript">

        var ids = [];
        
        $(document).ready(function(){
            $('div.section').hide();
            $('input.control-button').hide();
            $('select.sender-list').click(function(){
                if($(this).find('option:selected').length > 0 ) {
                   $('input.control-button').show();
                } else {
                    $('input.control-button').hide();
                }
                
            });
            $('[id*="external-emails"]').bind('input change', function(){
                if(this.value.length) {
                    $('input.control-button').removeAttr('disabled');
                    $('input.control-button').show();
                } else {
                    $('input.control-button').hide();
                }
            });            
            $('#send-form-to-select').change(function(){
                var sectionToDisplay = $('#send-form-to-select option:selected').val();
                $('[id*="sendTo"]').val(sectionToDisplay);

                $('input.control-button').hide();
                $('div.section').hide();                    
                $('select option:selected').each(function(){$(this).removeAttr('selected')});
                $('#'+sectionToDisplay).show();
                $('input:checkbox').removeAttr('checked');
                ids = [];
            });

            $('input:checkbox').change(function() {

                if($(this).is(":checked")) {
                    ids.push($(this).attr("data-id"));
                }else {
                    var index = $.inArray($(this).attr("data-id"), ids);
                        if (index >= 0) {
                        ids.splice(index, 1);
                    }
                }
            });
        });

        

        function doValidateAndSendForm() {
            if($('#others').is(':visible')) { 
                var success = validateEmails();   
                if(!success) {
                    $('#email-error').show();
                    $('input.control-button').hide();
                     return;
                }
            }   

            if($('#contacts').is(':visible') || $('#users').is(':visible')) { 
                $('[id*="selectedIds"]').val(ids);
            }

            sendSurveyForm();
        }

        function validateEmails() {  
          var emailList= $('[id*="external-emails"]').val().split(',');
            for (i=0;i<emailList.length;i++) {
               var regex = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
               if(!regex.test(emailList[i].trim()))
               return false;
            }
            return true;
        }

        $(document).ready( function() {
            $('#contacttable').dataTable();
            $('#usertable').dataTable();
        } );

        var checkboxes = $('input:checkbox'),
            submitButt = $('input.control-button');


        checkboxes.click(function() {
            if(checkboxes.is(":checked"))
                submitButt.show();
            else
                submitButt.hide();
        });

    </script>
</apex:page>
