<apex:page showHeader="true" sidebar="false" tabStyle="Trifecta_Survey__c" standardStylesheets="false" controller="TTISGSendSurveyController">
    <apex:includescript value="//code.jquery.com/jquery-1.11.1.min.js" / >
    <apex:includescript value="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" />
    <apex:stylesheet value="//cdn.datatables.net/1.10.4/css/jquery.dataTables.css" />
    <apex:stylesheet value="{!URLFOR($Resource.SurveyGuru, 'styles/custom/sendSurveyCSS.css')}"/>
    
    <apex:form id="sendSurvey">
        <div class="form-container">
            <div id="show-img">
                <img src="progress.gif" id="imgProg"
                visible="false" alt="loading data..." />                
            </div>
            <div id="main-div" style="display: none;">
                <div><apex:pageMessages /></div>
                <div class="font-large bold-text margin-0.625em">{!survey.Name}</div>
                <hr />
                <table class="table">
                    <tr><th colspan="2" style="float: right;">
                        Send Form to<select id="send-form-to-select" class="select-box">
                                <option value="users">Users</option> 
                                <option value="contacts">Contacts</option> 
                                <option value="groups">Groups</option> 
                                <option value="others">Others</option> 
                        </select></th>
                    </tr>
                   <tr>
                        <td><div id="users" class="section" style="display: none;">


                            <table id="usertable" class="display">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="userSelectAllChbx" /></th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Image</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <apex:repeat value="{!userDetailsList}" var="userDetail">
                                        <tr>
                                            <td><input type="checkbox" data-id="{!userDetail.user.Id}" value="{!userDetail.selected}"  /></td> 
                                            <td>{!userDetail.user.FirstName}</td>
                                            <td>{!userDetail.user.LastName}</td>
                                            <td><apex:image url="{!userDetail.user.smallphotourl}" /></td>
                                        </tr>
                                    </apex:repeat>
                                </tbody>
                            </table>
                            <apex:outputPanel rendered="{!userDetailsList.size == 0}">No Users exist.</apex:outputPanel>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="contacts" class="section" style="display: none;">

                                <table id="contacttable" class="display">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="contactSelectAllChbx" /></th>
                                            <th>First Name</th>
                                            <th>Last Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <apex:repeat value="{!contactDetailsList}" var="contactDetail">
                                            <tr>
                                                <td><input type="checkbox" data-id="{!contactDetail.contact.Id}" value="{!contactDetail.selected}"  /></td> 
                                                <td>{!contactDetail.contact.FirstName}</td>
                                                <td>{!contactDetail.contact.LastName}</td>
                                            </tr>
                                        </apex:repeat>
                                    </tbody>
                                </table>
                                <apex:outputPanel rendered="{!contactDetailsList.size == 0}">No Contacts exist.</apex:outputPanel>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="groups" class="section" style="display: none;">
                                <apex:outputPanel rendered="{! groupsList.size != 0}">
                                        <label class="bold-text">Select Groups</label>
                                        <apex:selectList styleClass="sender-list ui-selectmenu-button ui-widget ui-state-default ui-corner-top" style="overflow:auto" id="select-groups" size="1" value="{!selectedGroups}">
                                            <apex:selectOptions value="{!groupsList}"/>
                                        </apex:selectList>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!groupsList.size == 0}">No Groups exist.</apex:outputPanel>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="others" class="section" style="display: none;">
                                <apex:outputPanel >
                                    <label class="bold-text">External Emails</label><br/ >
                                    <label class="small-text">Please select list of comma seperated email ids.</label>
                                    <br />
                                    <apex:inputTextarea id="external-emails" value="{!externalContacts}" rows="5"  cols="100" /> 
                                </apex:outputPanel><br/>
                                <span id="email-error" class="error" style="display: none;">Invalid Email Ids</span>
                            </div>
                        </td>
                    </tr>
                    <tr><td>
                            <apex:outputPanel >
                                <input type="button" style="display: none;" class="control-button" value="Send Form" onclick="doValidateAndSendForm()" />
                            </apex:outputPanel>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <apex:inputHidden value="{!sendTo}" id="sendTo"/>
        <apex:inputHidden value="{!selectedIds}" id="selectedIds"/>
        <apex:actionFunction action="{!sendForm}" name="sendSurveyForm" />
    </apex:form>
    <script type="text/javascript">

        var ids = [];
        
        $(document).ready(function(){

            $("#show-img").hide();
            $("#main-div").show();

            $('div.section').hide();
            $('input.control-button').hide();
            $('select.sender-list').click(function(){
                if($(this).find('option:selected').length > 0 ) {
                   $('input.control-button').show();
                } else {
                    $('input.control-button').hide();
                }
                
            });
            $('[id*="external-emails"]').bind('input change', function(){
                if(this.value.length) {
                    $('input.control-button').removeAttr('disabled');
                    $('input.control-button').show();
                } else {
                    $('input.control-button').hide();
                }
            });            
            $('[id*="sendTo"]').val('users');
            $('#users').show();
            $('#send-form-to-select').change(function(){
                var sectionToDisplay = $('#send-form-to-select option:selected').val();
                $('[id*="sendTo"]').val(sectionToDisplay);

                $('input.control-button').hide();
                $('div.section').hide();     

                $('#'+sectionToDisplay).show();
                $('input:checkbox').removeAttr('checked');
                ids = [];
            });

            function selectAllRows(tableObj) {
                $('input', tableObj.fnGetNodes()).each(function () {
                    $(this).prop('checked',true);

                    var index = $.inArray($(this).attr("data-id"), ids);
                    if(index == -1)
                        ids.push($(this).attr("data-id"));
                });
            }

            function unSelectAllRows(tableObj) {
                $('input', tableObj.fnGetNodes()).removeAttr('checked');
                ids = [];
            }

            $('input:checkbox').change(function() {

                if($(this).is(":checked")) {
                    if($(this).is($('#userSelectAllChbx'))) {
                        selectAllRows($('#usertable').dataTable());
                    } else if($(this).is($('#contactSelectAllChbx'))) {
                        selectAllRows($('#contacttable').dataTable());
                    } else {
                        ids.push($(this).attr("data-id"));   
                    }
                }else {

                    if($(this).is($('#userSelectAllChbx'))) {
                        unSelectAllRows($('#usertable').dataTable());
                    } else if($(this).is($('#contactSelectAllChbx'))) {
                        unSelectAllRows($('#contacttable').dataTable());
                    } else {
                        var index = $.inArray($(this).attr("data-id"), ids);
                        if (index >= 0) {
                            ids.splice(index, 1);
                        }
                    }
                }
            });
        });

        

        function doValidateAndSendForm() {
            if($('#others').is(':visible')) { 
                var success = validateEmails();   
                if(!success) {
                    $('#email-error').show();
                    $('input.control-button').hide();
                     return;
                }
            }   

            if($('#contacts').is(':visible') || $('#users').is(':visible')) { 
                $('[id*="selectedIds"]').val(ids);
            }

            sendSurveyForm();
        }

        function validateEmails() {  
          var emailList= $('[id*="external-emails"]').val().split(',');
            for (i=0;i<emailList.length;i++) {
               var regex = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
               if(!regex.test(emailList[i].trim()))
               return false;
            }
            return true;
        }

        $(document).ready( function() {
            $('#contacttable').dataTable();
            $('#usertable').dataTable();
        } );

        var checkboxes = $('input:checkbox'),
            submitButt = $('input.control-button');


        checkboxes.click(function() {
            if(checkboxes.is(":checked"))
                submitButt.show();
            else
                submitButt.hide();
        });

    </script>
</apex:page>